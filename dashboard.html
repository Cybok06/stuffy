<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Dashboard â€¢ Stockly</title>
  <style>
    :root{
      --bg:#f6f7fb; --ink:#171717; --muted:#6b7280; --ring:#e6e8ef;
      --primary:#6f2cff; --primary-2:#5b22d1; --card:#ffffff; --shadow:0 10px 30px rgba(0,0,0,.06);
      --good:#16a34a; --warn:#f59e0b; --bad:#ef4444; --info:#0ea5e9;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}

    .shell{min-height:100dvh;display:flex;flex-direction:column}
    .top{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:14px 18px;background:var(--card);border-bottom:1px solid var(--ring);
      position:sticky;top:0;z-index:10;
    }
    .brand{font-weight:800;letter-spacing:.3px}
    .top-right{display:flex;gap:8px;align-items:center}
    .btn{border:1px solid var(--ring);background:#fff;padding:10px 14px;border-radius:12px;cursor:pointer}
    .btn:hover{background:#fafafa}
    .btn-primary{border:1px solid transparent;background:var(--primary);color:#fff}
    .btn-primary:hover{background:var(--primary-2)}
    .content{flex:1;display:grid;gap:14px;padding:16px;max-width:1180px;margin:0 auto;width:100%}

    /* greeting */
    .greet{display:flex;flex-wrap:wrap;align-items:center;gap:8px;margin-top:4px}
    .hello{font-size:24px;margin:0}
    .muted{color:var(--muted)}

    /* KPI grid */
    .kpis{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(min-width:760px){ .kpis{grid-template-columns:repeat(4,1fr)} }
    .kcard{background:var(--card);border:1px solid var(--ring);border-radius:16px;box-shadow:var(--shadow);padding:14px 16px}
    .khead{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
    .khead .label{font-size:12px;font-weight:800;color:var(--muted);letter-spacing:.3px;text-transform:uppercase}
    .kval{font-size:24px;font-weight:800;margin:0}
    .kdelta{font-size:12px;margin-top:4px}
    .up{color:var(--good)} .down{color:var(--bad)}

    /* main grid */
    .grid{
      display:grid;gap:12px;
      grid-template-columns:1fr;
    }
    @media(min-width:980px){
      .grid{grid-template-columns:2fr 1fr}
    }

    .card{background:var(--card);border:1px solid var(--ring);border-radius:16px;box-shadow:var(--shadow);padding:16px}
    .card h3{margin:0 0 10px;font-size:16px}
    .subtle{color:var(--muted);font-size:13px;margin:0 0 12px}

    /* lists */
    .list{display:grid;gap:10px}
    .row{
      display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center;
      border:1px solid var(--ring);border-radius:10px;padding:10px 12px;background:#fff
    }
    .row .name{font-weight:800;margin:0}
    .row .sub{margin:2px 0 0;color:var(--muted);font-size:13px}
    .row .badge{font-weight:800;border-radius:999px;padding:6px 10px;border:1px solid var(--ring);background:#f9fafb;white-space:nowrap}

    /* recent activity */
    .activity{display:grid;gap:10px}
    .act{
      display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center;
      background:#fff;border:1px solid var(--ring);border-radius:10px;padding:10px 12px;
    }
    .atype{font-weight:700}
    .atime{color:var(--muted);font-size:12px}
    .atag{border-radius:999px;padding:6px 10px;border:1px solid var(--ring);background:#f9fafb;font-weight:800}

    /* canvases */
    .chart{width:100%;height:280px;border:1px solid var(--ring);border-radius:12px}
    .chart-small{width:100%;height:240px;border:1px solid var(--ring);border-radius:12px}

    /* bottom nav quick links */
    .quick{display:flex;flex-wrap:wrap;gap:8px;margin-top:4px}
  </style>
</head>
<body>
 <!-- Bootstrap 5 (CDN) -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<style>
  :root{
    --sb-w: 264px;
    --sb-bg: #ffffff;
    --sb-ring: #e6e8ef;
  }

  /* Only push content when the sidebar is open on desktop */
  @media (min-width: 992px){
    body.sidebar-open{ margin-left: var(--sb-w); transition: margin-left .28s cubic-bezier(.22,.98,.2,1); }
  }

  /* Sidebar size */
  #appSidebar{
    width: var(--sb-w);
    background: var(--sb-bg);
    border-right: 1px solid var(--sb-ring);
  }
  @media (max-width: 991.98px){
    #appSidebar{ width: min(86vw, 320px); }
  }

  /* Hide Bootstrap backdrop on desktop (we push the layout instead) */
  @media (min-width: 992px){
    .offcanvas-backdrop{ display:none !important; }
  }

  /* Hamburger launcher (show on ALL sizes so desktop can toggle too) */
  #sbToggle{
    position: fixed; left: 12px; top: 12px; z-index: 1056;
    border: 1px solid var(--sb-ring);
    box-shadow: 0 8px 20px rgba(0,0,0,.08);
  }

  /* Small visual polish */
  .sb-brand{
    display:flex; align-items:center; gap:10px; font-weight:900;
  }
  .sb-logo{
    width:36px; height:36px; border-radius:10px; background:#6f2cff; color:#fff;
    display:grid; place-items:center;
  }
  .sb-user{ border:1px solid var(--sb-ring); }
  .sb-badge{ font-weight:700; border:1px solid var(--sb-ring); }
</style>

<!-- Toggle button (works on mobile & desktop) -->
<button id="sbToggle" class="btn btn-light" type="button"
        data-bs-toggle="offcanvas" data-bs-target="#appSidebar" aria-controls="appSidebar" aria-label="Open menu">
  <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
    <path d="M4 6h16M4 12h16M4 18h16" stroke-linecap="round"/>
  </svg>
</button>

<!-- Sidebar -->
<div id="appSidebar"
     class="offcanvas offcanvas-start"
     data-bs-scroll="true" data-bs-backdrop="true" tabindex="-1" aria-labelledby="appSidebarLabel">

  <div class="offcanvas-header border-bottom">
    <div class="sb-brand">
      <div class="fs-5"></div>
    </div>
    <!-- Show the close button on ALL sizes so desktop can close too -->
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>

  <div class="offcanvas-body d-flex flex-column pt-3 pb-3">
    <!-- Quick search (routes to Inventory) -->
    <div class="input-group mb-3">
      <span class="input-group-text bg-white border-end-0">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.3-4.3"/></svg>
      </span>
      <input id="sbSearch" type="search" class="form-control border-start-0" placeholder="Quick search productsâ€¦">
    </div>

    <!-- Nav -->
    <ul class="nav nav-pills flex-column gap-1 mb-3" id="sbNav">
      <li class="nav-item">
        <a class="nav-link d-flex align-items-center gap-2" href="dashboard.html" data-link>
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3v18h18"/><path d="M7 13l3 3 7-7"/></svg>
          <span>Dashboard</span>
        </a>
      </li>

      <li class="nav-item">
        <a class="nav-link d-flex align-items-center justify-content-between" href="products.html" data-link>
          <span class="d-flex align-items-center gap-2">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
            Inventory
          </span>
          <span id="sbLow" class="badge rounded-pill sb-badge text-bg-warning-subtle d-none">0 low</span>
        </a>
      </li>

      <li class="nav-item">
        <a class="nav-link d-flex align-items-center gap-2" href="make_sale.html" data-link>
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 6h15l-1 7H7z"/><circle cx="9" cy="20" r="1"/><circle cx="18" cy="20" r="1"/></svg>
          <span>Make sale</span>
        </a>
      </li>

      <li class="nav-item">
        <a class="nav-link d-flex align-items-center gap-2" href="sales_history.html" data-link>
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3v18h18"/><path d="M7 13l3 3 7-7"/></svg>
          <span>Sales history</span>
        </a>
      </li>

      <li class="nav-item">
        <a class="nav-link d-flex align-items-center justify-content-between" href="notification.html" data-link>
          <span class="d-flex align-items-center gap-2">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8a6 6 0 10-12 0c0 7-3 7-3 7h18s-3 0-3-7"/><path d="M13.73 21a2 2 0 01-3.46 0"/></svg>
            Notifications
          </span>
          <span id="sbNotif" class="badge rounded-pill sb-badge text-bg-info-subtle d-none">0</span>
        </a>
      </li>

      <li><hr class="dropdown-divider my-2"></li>

      <li class="nav-item">
        <a class="nav-link d-flex align-items-center gap-2" href="settings.html" data-link>
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 11-2.83 2.83l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V22a2 2 0 11-4 0v-.09a1.65 1.65 0 00-1-1.51 1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 11-2.83-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H2a2 2 0 110-4h.09a1.65 1.65 0 001.51-1z"/></svg>
          <span>Settings</span>
        </a>
      </li>

      <li class="nav-item">
        <a class="nav-link d-flex align-items-center gap-2" href="help.html" data-link>
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.82 1c0 2-3 2-3 4"/><path d="M12 17h.01"/></svg>
          <span>Help & support</span>
        </a>
      </li>
    </ul>

    <!-- User box -->
    <div class="card sb-user mt-auto">
      <div class="card-body d-flex align-items-center gap-2">
        <div id="sbAvatar" class="rounded-3 bg-primary-subtle text-primary-emphasis fw-bold d-inline-grid place-items-center"
             style="width:38px;height:38px;">S</div>
        <div class="flex-grow-1">
          <div id="sbUname" class="fw-bold">â€”</div>
          <div id="sbUemail" class="text-muted small">â€”</div>
        </div>
        <button id="sbLogout" class="btn btn-outline-secondary btn-sm">Log out</button>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  // Keys used across the app
  const CURRENT_KEY  = 'stockly_current_user';
  const PRODUCTS_KEY = 'stockly_products_v1';
  const NOTIFS_KEY   = 'stockly_notifs_v1';

  const ocEl = document.getElementById('appSidebar');

  // When the offcanvas opens/closes, toggle a class on <body> (desktop layout push)
  ocEl.addEventListener('shown.bs.offcanvas', ()=> document.body.classList.add('sidebar-open'));
  ocEl.addEventListener('hidden.bs.offcanvas', ()=> document.body.classList.remove('sidebar-open'));

  // Highlight active link
  const current = (location.pathname.split('/').pop() || 'dashboard.html').toLowerCase();
  document.querySelectorAll('#appSidebar a[data-link]').forEach(a=>{
    if ((a.getAttribute('href')||'').toLowerCase() === current) a.classList.add('active');
  });

  // Fill user box
  let user=null; try{ user = JSON.parse(localStorage.getItem(CURRENT_KEY)||'null'); }catch(e){}
  const uname = document.getElementById('sbUname');
  const uemail= document.getElementById('sbUemail');
  const avatar= document.getElementById('sbAvatar');
  if(user && user.name){
    uname.textContent = user.name;
    uemail.textContent = user.email || '';
    avatar.textContent = (user.name[0]||'S').toUpperCase();
  }else{
    uname.textContent = 'Guest'; uemail.textContent = 'Not signed in'; avatar.textContent='S';
  }

  // Badges: low/out & notifications
  (function updateBadges(){
    const lowEl = document.getElementById('sbLow');
    const notifEl = document.getElementById('sbNotif');

    let low=0, out=0;
    try{
      const prods = JSON.parse(localStorage.getItem(PRODUCTS_KEY)||'[]');
      const mine  = user?.id ? prods.filter(p=>p.ownerId===user.id) : prods;
      for(const p of mine){
        const q = Number(p.qty)||0;
        if(q===0) out++; else if(q<=4) low++;
      }
    }catch(e){}
    if(low>0 || out>0){
      lowEl.classList.remove('d-none');
      lowEl.textContent = `${low} low${out?`, ${out} out`:''}`;
      if(out>0){ lowEl.classList.add('text-bg-danger-subtle'); }
    }

    let count=0;
    try{
      const ns = JSON.parse(localStorage.getItem(NOTIFS_KEY)||'[]');
      const since = Date.now() - 30*86400000;
      count = ns.filter(n => (!user?.id || n.ownerId===user.id) && (n.createdAtMs||0) >= since).length;
    }catch(e){}
    if(count>0){
      notifEl.classList.remove('d-none');
      notifEl.textContent = String(count);
    }
  })();

  // Quick search â†’ Inventory page
  document.getElementById('sbSearch')?.addEventListener('keydown', (e)=>{
    if(e.key === 'Enter'){
      const q = (e.currentTarget.value || '').trim();
      location.href = q ? ('products.html#q=' + encodeURIComponent(q)) : 'products.html';
      const oc = bootstrap.Offcanvas.getInstance(ocEl);
      oc?.hide();
    }
  });

  // Logout
  document.getElementById('sbLogout')?.addEventListener('click', ()=>{
    localStorage.removeItem(CURRENT_KEY);
    location.href = 'login.html';
  });
})();
</script>


  <div class="shell">
    <header class="top">
      <div class="brand"></div>
      <div class="top-right">
        <button class="btn" onclick="location.href='products.html'"></button>
        <button class="btn" onclick="location.href='sales_history.html'"></button>
        <button class="btn" onclick="location.href='make_sale.html'"> </button>
        <button id="logoutBtn" class="btn" type="button"> </button>
      </div>
    </header>

    <main class="content">
      <section class="greet">
        <h1 class="hello">Welcome, <span id="username">â€”</span> ðŸ‘‹</h1>
        <p class="muted" id="period">Hereâ€™s whatâ€™s happening in your store.</p>
      </section>

      <!-- KPIs -->
      <section class="kpis">
        <div class="kcard">
          <div class="khead"><span class="label">Total revenue</span></div>
          <p id="k-rev" class="kval">â‚µ 0.00</p>
          <div id="k-rev-d" class="kdelta muted">â€”</div>
        </div>
        <div class="kcard">
          <div class="khead"><span class="label">Units sold</span></div>
          <p id="k-units" class="kval">0</p>
          <div id="k-units-d" class="kdelta muted">â€”</div>
        </div>
        <div class="kcard">
          <div class="khead"><span class="label">Products</span></div>
          <p id="k-prods" class="kval">0</p>
          <div class="kdelta muted"><span id="k-low" class="down">0 low</span> â€¢ <span id="k-out" class="down">0 out</span></div>
        </div>
        <div class="kcard">
          <div class="khead"><span class="label">Avg order value</span></div>
          <p id="k-aov" class="kval">â‚µ 0.00</p>
          <div id="k-aov-d" class="kdelta muted">â€”</div>
        </div>
      </section>

      <section class="grid">
        <!-- Left column -->
        <div class="col">
          <div class="card">
            <h3>Revenue â€” last 14 days</h3>
            <p class="subtle">Daily totals. Use this to spot trends week-over-week.</p>
            <canvas id="chartRevenue" class="chart" width="900" height="280"></canvas>
          </div>

          <div class="card">
            <h3>Trending products</h3>
            <p class="subtle">Top 5 by units sold in the last 30 days.</p>
            <canvas id="chartTop" class="chart-small" width="900" height="240"></canvas>
            <div id="topList" class="list" style="margin-top:10px"></div>
          </div>
        </div>

        <!-- Right column -->
        <div class="col">
          <div class="card">
            <h3>Stock breakdown</h3>
            <p class="subtle">Proportion of in-stock, low, and out-of-stock items.</p>
            <canvas id="chartStock" class="chart-small" width="900" height="240"></canvas>
            <div class="quick">
              <button class="btn" onclick="location.href='products.html'">Manage inventory</button>
              <button class="btn" onclick="location.href='notifications.html'">Notifications</button>
            </div>
          </div>

          <div class="card">
            <h3>Recent activity</h3>
            <p class="subtle">Last few sales and stock alerts.</p>
            <div id="activity" class="activity"></div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script>
    // storage keys
    const CURRENT_KEY  = 'stockly_current_user';
    const PRODUCTS_KEY = 'stockly_products_v1';
    const SALES_KEY    = 'stockly_sales_v1';
    const NOTIFS_KEY   = 'stockly_notifs_v1';

    // Guard: require login
    let user = null;
    try { user = JSON.parse(localStorage.getItem(CURRENT_KEY) || 'null'); } catch(e) {}
    if (!user || !user.name) {
      location.href = 'login.html';
    }

    // Utilities
    const fmtMoney = n => `â‚µ ${Number(n||0).toFixed(2)}`;
    const startOfDay = d => new Date(d.getFullYear(), d.getMonth(), d.getDate());
    const dayKey = d => {
      const y=d.getFullYear(), m=(d.getMonth()+1+'').padStart(2,'0'), dd=(d.getDate()+'').padStart(2,'0');
      return `${y}-${m}-${dd}`;
    };
    const read = (k) => { try { return JSON.parse(localStorage.getItem(k)) || []; } catch(e){ return []; } };

    // Put username
    document.getElementById('username').textContent = user.name;
    document.getElementById('period').textContent = `Hereâ€™s whatâ€™s happening in your store as of ${new Date().toLocaleString()}.`;

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', () => {
      localStorage.removeItem(CURRENT_KEY);
      location.href = 'login.html';
    });

    // Data for this owner
    const productsAll = read(PRODUCTS_KEY).filter(p => p.ownerId === user.id);
    const salesAll    = read(SALES_KEY).filter(s => s.ownerId === user.id).sort((a,b)=>(a.createdAtMs||0)-(b.createdAtMs||0));
    const notifsAll   = read(NOTIFS_KEY).filter(n => n.ownerId === user.id).sort((a,b)=>(b.createdAtMs||0)-(a.createdAtMs||0));

    // --- KPIs ---
    (function kpis(){
      // revenue, units, orders
      let revenue=0, units=0;
      for(const s of salesAll){ revenue += Number(s.total)||0; units += Number(s.qty)||0; }
      const orders = salesAll.length;
      const aov = orders ? (revenue / orders) : 0;

      // products + stock status
      const prodCount = productsAll.length;
      let low=0, out=0;
      for(const p of productsAll){
        const q = Number(p.qty)||0;
        if(q===0) out++;
        else if(q<=4) low++;
      }

      // simple deltas: compare last 7d vs prev 7d
      function sumRange(daysBackStart, days){
        const end = startOfDay(new Date()).getTime() + 86400000; // tomorrow 00:00
        const from = end - (daysBackStart+days)*86400000;
        const to   = end - daysBackStart*86400000;
        let rev=0, u=0;
        for(const s of salesAll){
          const t = s.createdAtMs || Date.parse(s.createdAt) || 0;
          if(t>=from && t<to){ rev += Number(s.total)||0; u += Number(s.qty)||0; }
        }
        return {rev:rev,u:u,orders:0};
      }
      const curr7 = sumRange(0,7), prev7 = sumRange(7,7);
      const revDelta = prev7.rev ? ((curr7.rev-prev7.rev)/prev7.rev*100) : (curr7.rev?100:0);
      const unitDelta = prev7.u ? ((curr7.u-prev7.u)/prev7.u*100) : (curr7.u?100:0);
      const aovCurr = curr7.u ? curr7.rev / (salesAll.filter(s => (s.createdAtMs||0) >= (Date.now()-7*86400000)).length||1) : 0;
      const aovPrev = prev7.u ? prev7.rev / (salesAll.filter(s => {
        const t=s.createdAtMs||0; const now=Date.now();
        return t < (now-7*86400000) && t >= (now-14*86400000);
      }).length||1) : 0;
      const aovDelta = aovPrev ? ((aovCurr-aovPrev)/aovPrev*100) : (aovCurr?100:0);

      // write
      document.getElementById('k-rev').textContent = fmtMoney(revenue);
      document.getElementById('k-units').textContent = units;
      document.getElementById('k-prods').textContent = prodCount;
      document.getElementById('k-aov').textContent = fmtMoney(aov);

      const revD = document.getElementById('k-rev-d');
      revD.textContent = `${revDelta>=0?'+':''}${revDelta.toFixed(0)}% vs last 7d`;
      revD.className = 'kdelta ' + (revDelta>=0?'up':'down');

      const unD = document.getElementById('k-units-d');
      unD.textContent = `${unitDelta>=0?'+':''}${unitDelta.toFixed(0)}% vs last 7d`;
      unD.className = 'kdelta ' + (unitDelta>=0?'up':'down');

      const aovD = document.getElementById('k-aov-d');
      aovD.textContent = `${aovDelta>=0?'+':''}${aovDelta.toFixed(0)}% vs last 7d`;
      aovD.className = 'kdelta ' + (aovDelta>=0?'up':'down');

      document.getElementById('k-low').textContent = `${low} low`;
      document.getElementById('k-out').textContent = `${out} out`;
    })();

    // --- Revenue chart (last 14 days) ---
    (function revenueChart(){
      const days = 14;
      const map = new Map(); // key -> sum
      const today = startOfDay(new Date());
      for(let i=days-1;i>=0;i--){
        const d = new Date(today.getTime() - i*86400000);
        map.set(dayKey(d), 0);
      }
      for(const s of salesAll){
        const t = new Date(s.createdAt || s.createdAtMs || Date.now());
        const k = dayKey(t);
        if(map.has(k)){ map.set(k, (map.get(k)||0) + (Number(s.total)||0)); }
      }
      const labels = Array.from(map.keys());
      const values = Array.from(map.values());

      const canvas = document.getElementById('chartRevenue');
      const ctx = canvas.getContext('2d');

      // clear
      ctx.clearRect(0,0,canvas.width,canvas.height);

      // padding
      const pad = {l:48, r:16, t:16, b:28};
      const W = canvas.width - pad.l - pad.r;
      const H = canvas.height - pad.t - pad.b;

      // y scale
      const maxVal = Math.max(...values, 10);
      const yMax = Math.ceil(maxVal/10)*10;
      const yTicks = 5;

      // axes
      ctx.strokeStyle = '#e5e7eb';
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(pad.l, pad.t);
      ctx.lineTo(pad.l, pad.t+H);
      ctx.lineTo(pad.l+W, pad.t+H);
      ctx.stroke();

      // grid + labels
      ctx.fillStyle = '#6b7280';
      ctx.font = '12px system-ui, -apple-system, Segoe UI, Roboto, Arial';
      for(let i=0;i<=yTicks;i++){
        const y = pad.t + H - (H*(i/yTicks));
        const v = (yMax*(i/yTicks));
        ctx.strokeStyle = '#eef0f5';
        ctx.beginPath(); ctx.moveTo(pad.l, y); ctx.lineTo(pad.l+W, y); ctx.stroke();
        ctx.fillText(fmtMoney(v), 6, y+4);
      }

      // x labels (every 2nd day)
      const stepX = W / (labels.length-1 || 1);
      for(let i=0;i<labels.length;i++){
        if(i%2) continue;
        const x = pad.l + i*stepX;
        const d = labels[i].slice(5); // MM-DD
        ctx.fillText(d, x-10, pad.t+H+18);
      }

      // line
      ctx.lineWidth = 2;
      ctx.strokeStyle = '#6f2cff';
      ctx.beginPath();
      values.forEach((v,i)=>{
        const x = pad.l + i*stepX;
        const y = pad.t + H - (H*(v/yMax));
        if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      });
      ctx.stroke();

      // fill under
      const grad = ctx.createLinearGradient(0,pad.t,0,pad.t+H);
      grad.addColorStop(0,'rgba(111,44,255,.18)');
      grad.addColorStop(1,'rgba(111,44,255,0)');
      ctx.fillStyle = grad;
      ctx.lineTo(pad.l + (labels.length-1)*stepX, pad.t+H);
      ctx.lineTo(pad.l, pad.t+H);
      ctx.closePath();
      ctx.fill();

      // points
      ctx.fillStyle = '#6f2cff';
      values.forEach((v,i)=>{
        const x = pad.l + i*stepX;
        const y = pad.t + H - (H*(v/yMax));
        ctx.beginPath(); ctx.arc(x,y,3,0,Math.PI*2); ctx.fill();
      });
    })();

    // --- Trending products (top 5 by units in last 30 days) ---
    (function trending(){
      const since = Date.now() - 30*86400000;
      const agg = new Map(); // name -> {qty, revenue}
      for(const s of salesAll){
        const t = s.createdAtMs || Date.parse(s.createdAt) || 0;
        if(t < since) continue;
        const name = (s.product?.name || 'Product');
        const qty = Number(s.qty)||0;
        const total = Number(s.total)||0;
        const cur = agg.get(name) || {qty:0, rev:0};
        cur.qty += qty; cur.rev += total;
        agg.set(name, cur);
      }
      const arr = Array.from(agg.entries()).sort((a,b)=>b[1].qty-a[1].qty).slice(0,5);
      const labels = arr.map(([name])=>name);
      const values = arr.map(([,v])=>v.qty);

      // bar chart
      const canvas = document.getElementById('chartTop');
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0,0,canvas.width,canvas.height);

      const pad = {l:40, r:16, t:10, b:34};
      const W = canvas.width - pad.l - pad.r;
      const H = canvas.height - pad.t - pad.b;

      // axes
      ctx.strokeStyle = '#e5e7eb';
      ctx.lineWidth = 1;
      ctx.beginPath(); ctx.moveTo(pad.l, pad.t); ctx.lineTo(pad.l, pad.t+H); ctx.lineTo(pad.l+W, pad.t+H); ctx.stroke();

      // bars
      const n = Math.max(values.length, 1);
      const barW = n ? (W / n * 0.6) : 0;
      const maxV = Math.max(1, ...values);
      labels.forEach((lb,i)=>{
        const xCenter = pad.l + (i+0.5) * (W/n);
        const v = values[i];
        const h = H * (v / maxV);
        const x = xCenter - barW/2;
        const y = pad.t + H - h;

        // bar
        ctx.fillStyle = '#6f2cff';
        ctx.fillRect(x, y, barW, h);

        // label
        ctx.fillStyle = '#6b7280';
        ctx.font = '12px system-ui,-apple-system,Segoe UI,Roboto,Arial';
        let lbl = lb.length>12 ? lb.slice(0,11)+'â€¦' : lb;
        ctx.fillText(lbl, xCenter - ctx.measureText(lbl).width/2, pad.t+H+18);

        // value on top
        ctx.fillStyle = '#111827';
        ctx.font = '12px system-ui,-apple-system,Segoe UI,Roboto,Arial';
        ctx.fillText(String(v), xCenter - ctx.measureText(String(v)).width/2, y-6);
      });

      // details list
      const topList = document.getElementById('topList');
      topList.innerHTML = '';
      if(!arr.length){
        topList.innerHTML = '<div class="muted">No sales in the last 30 days.</div>';
      } else {
        arr.forEach(([name, v])=>{
          const row = document.createElement('div');
          row.className='row';
          row.innerHTML = `
            <div>
              <div class="name">${name}</div>
              <div class="sub">${v.qty} sold â€¢ ${fmtMoney(v.rev)}</div>
            </div>
            <div class="badge">${v.qty}</div>
          `;
          topList.appendChild(row);
        });
      }
    })();

    // --- Stock breakdown (donut) ---
    (function stockChart(){
      let low=0, out=0, ok=0;
      for(const p of productsAll){
        const q=Number(p.qty)||0;
        if(q===0) out++;
        else if(q<=4) low++;
        else ok++;
      }
      const data=[ok,low,out];
      const colors=['#16a34a','#f59e0b','#ef4444'];
      const labels=['In stock','Low','Out'];

      const total=data.reduce((a,b)=>a+b,0) || 1;

      const canvas=document.getElementById('chartStock');
      const ctx=canvas.getContext('2d');
      const cx=canvas.width/2, cy=canvas.height/2;
      const r = Math.min(canvas.width, canvas.height)*0.38;
      const rInner = r*0.6;

      // bg
      ctx.clearRect(0,0,canvas.width,canvas.height);

      // slices
      let angle=-Math.PI/2;
      data.forEach((v,i)=>{
        const slice = (v/total)*Math.PI*2;
        ctx.beginPath();
        ctx.moveTo(cx,cy);
        ctx.arc(cx,cy,r,angle,angle+slice);
        ctx.closePath();
        ctx.fillStyle=colors[i];
        ctx.fill();
        angle += slice;
      });
      // inner hole
      ctx.globalCompositeOperation='destination-out';
      ctx.beginPath(); ctx.arc(cx,cy,rInner,0,Math.PI*2); ctx.fill();
      ctx.globalCompositeOperation='source-over';

      // center labels
      ctx.fillStyle='#111827';
      ctx.font='18px system-ui,-apple-system,Segoe UI,Roboto,Arial';
      ctx.textAlign='center';
      ctx.fillText(total+' items', cx, cy-2);
      ctx.fillStyle='#6b7280';
      ctx.font='12px system-ui,-apple-system,Segoe UI,Roboto,Arial';
      ctx.fillText(`${labels[0]} ${data[0]} â€¢ ${labels[1]} ${data[1]} â€¢ ${labels[2]} ${data[2]}`, cx, cy+16);
    })();

    // --- Recent activity ---
    (function activityFeed(){
      const container = document.getElementById('activity');
      container.innerHTML = '';
      const last = notifsAll.slice(0,6);
      if(!last.length){
        container.innerHTML = '<div class="muted">Nothing yet. Make a sale to see activity here.</div>';
        return;
      }
      for(const n of last){
        const t = new Date(n.createdAtMs || Date.now());
        const time = t.toLocaleString();
        const typeMap = {
          sale:'Sale',
          low_stock:'Low stock',
          out_of_stock:'Out of stock',
          product_added:'New product'
        };
        const tag = n.type==='sale' ? `${n.qty} Ã— ${fmtMoney(n.unitPrice)}`
                 : n.type==='low_stock' ? `${n.qty} left`
                 : n.type==='out_of_stock' ? `restock needed`
                 : `added`;
        const row = document.createElement('div');
        row.className='act';
        row.innerHTML = `
          <div>
            <div class="atype">${typeMap[n.type]||'Update'} â€¢ ${n.name||'Item'}</div>
            <div class="atime">${time}</div>
          </div>
          <div class="atag">${tag}</div>
        `;
        container.appendChild(row);
      }
    })();
  </script>
  

</body>
</html>
