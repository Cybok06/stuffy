<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Make sale • Stockly</title>
<style>
  :root{
    --bg:#f6f7fb; --ink:#171717; --muted:#6b7280; --ring:#e6e8ef; --card:#fff;
    --primary:#6f2cff; --primary-2:#5b22d1; --danger:#ef4444; --ok:#065f46;
    --shadow:0 10px 30px rgba(0,0,0,.06);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}

  .wrap{min-height:100dvh;display:flex;flex-direction:column}
  .topbar{display:flex;align-items:center;gap:12px;padding:12px 16px}
  .back{width:40px;height:40px;border-radius:999px;background:#fff;display:grid;place-items:center;border:1px solid var(--ring);cursor:pointer}
  .back svg{width:18px;height:18px}
  .title{margin:0 auto;font-weight:700}

  .content{padding:16px;display:grid;gap:14px;max-width:760px;margin:0 auto;width:100%}
  .search{display:flex;align-items:center;gap:10px;background:#fff;border:1px solid var(--ring);border-radius:12px;padding:12px}
  .search input{border:none;outline:none;flex:1;font-size:15px;background:transparent}

  .list{display:grid;gap:14px}
  .row{
    display:grid;grid-template-columns:56px 1fr auto;gap:12px;align-items:center;background:#fff;border:1px solid var(--ring);border-radius:14px;padding:12px;cursor:pointer
  }
  .row:hover{background:#fbfbff}
  .thumb{width:56px;height:56px;border-radius:10px;object-fit:cover;background:#f0f2f6;border:1px solid var(--ring)}
  .name{margin:0 0 4px;font-weight:700}
  .price{margin:0;color:#374151}
  .badge{
    padding:8px 12px;border-radius:999px;font-weight:700;font-size:13px
  }
  .b-red{background:#fee2e2;color:#b91c1c}
  .b-yellow{background:#fef3c7;color:#a16207}
  .b-green{background:#dcfce7;color:#166534}

  /* Toast (success) */
  .toast{
    position:fixed;left:16px;right:16px;top:16px;margin:auto;max-width:720px;z-index:50;
    background:#ecfdf5;border:1px solid #c8f5e8;border-radius:14px;box-shadow:0 10px 24px rgba(0,0,0,.08);
    padding:16px;display:none
  }
  .toast.show{display:block;animation:fade .35s ease-out both}
  @keyframes fade{from{opacity:0;transform:translateY(-10px)} to{opacity:1;transform:none}}

  /* Modal */
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:40}
  .overlay.show{display:flex}
  .modal{
    width:min(760px,96vw);background:#fff;border:1px solid var(--ring);border-radius:14px;box-shadow:var(--shadow);
    padding:18px;display:grid;gap:12px;
  }
  .prod-head{display:grid;grid-template-columns:64px 1fr auto;gap:12px;align-items:center}
  .prod-head .thumb{width:64px;height:64px;border-radius:12px}
  .pill{padding:8px 12px;border-radius:999px;font-weight:700;font-size:13px}
  .pill-red{background:#fee2e2;color:#b91c1c}
  /* NEW: pill colors for other stock levels */
  .pill-yellow{background:#fef3c7;color:#a16207}
  .pill-green{ background:#dcfce7;color:#166534}

  .qty-field .input{width:100%;border:1px solid var(--ring);border-radius:12px;padding:14px 12px;font-size:16px}
  .block{background:#f3f4f6;border:1px solid var(--ring);border-radius:12px;padding:12px 14px;font-weight:800;font-size:18px;display:flex;justify-content:space-between}
  .cta{display:grid;gap:10px}
  .btn{border:1px solid transparent;border-radius:14px;padding:14px 16px;font-weight:700;cursor:pointer}
  .btn-primary{background:var(--primary);color:#fff}
  .btn-primary:hover{background:var(--primary-2)}
  .btn-ghost{background:#fff;border:1px solid var(--ring)}
  .btn-ghost:hover{background:#fafafa}

  .alert{
    display:none;align-items:center;gap:10px;border:1px solid #fecaca;background:#fff1f2;color:#b91c1c;border-radius:12px;padding:12px 14px
  }
  .alert.show{display:flex}
</style>
</head>
<body>
 

  <div class="wrap">
    <header class="topbar">
      <button class="back" type="button" onclick="location.href='products.html'" aria-label="Back">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </button>
      <h1 class="title">Make sale</h1>
      <span style="width:40px"></span>
    </header>

    <!-- Success toast -->
    <div id="toast" class="toast" role="status" aria-live="polite">
      <strong style="display:block;color:#065f46;font-size:18px;margin-bottom:4px">Sales completed</strong>
      <span id="toastMsg" style="color:#065f46"></span>
    </div>

    <main class="content">
      <div class="search">
        <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.3-4.3"/></svg>
        <input id="q" type="search" placeholder="Search product to sell..." />
      </div>
      <div id="list" class="list"></div>
    </main>
  </div>

  <!-- Modal -->
  <div id="overlay" class="overlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="prod-head">
        <img id="mImg" class="thumb" alt="">
        <div>
          <div id="mName" style="font-weight:800;margin-bottom:4px">Product</div>
          <div id="mUnit" style="color:#374151">₵ 0.00 each</div>
        </div>
        <div id="mStock" class="pill pill-red">0 in stock</div>
      </div>

      <div id="alert" class="alert">
        <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12" y2="16"/></svg>
        <div>
          <div style="font-weight:800">Insufficient stock</div>
          <div id="alertMsg">Only N of this item is available</div>
        </div>
      </div>

      <div class="qty-field">
        <label for="mQty" style="font-weight:700;margin:6px 0 8px">Quantity to sell</label>
        <input id="mQty" class="input" type="number" min="1" step="1" />
      </div>

      <div class="block">
        <span>Total</span>
        <span id="mTotal">₵ 0.00</span>
      </div>

      <div class="cta">
        <button id="btnComplete" class="btn btn-primary" type="button">Complete sale</button>
        <button id="btnCancel" class="btn btn-ghost" type="button">Cancel</button>
      </div>
    </div>
  </div>

<script>
  const CURRENT_KEY  = 'stockly_current_user';
  const PRODUCTS_KEY = 'stockly_products_v1';
  const SALES_KEY    = 'stockly_sales_v1';
  const NOTIFS_KEY   = 'stockly_notifs_v1'; // NEW

  // Guard
  let current = null;
  try { current = JSON.parse(localStorage.getItem(CURRENT_KEY)||'null'); } catch(e){}
  if(!current){ location.href = 'login.html'; }

  // Helpers
  function readProducts(){ try { return JSON.parse(localStorage.getItem(PRODUCTS_KEY)) || []; } catch(e){ return []; } }
  function writeProducts(list){ localStorage.setItem(PRODUCTS_KEY, JSON.stringify(list)); }
  function readSales(){ try { return JSON.parse(localStorage.getItem(SALES_KEY)) || []; } catch(e){ return []; } }
  function writeSales(list){ localStorage.setItem(SALES_KEY, JSON.stringify(list)); }

  // Notifications helpers (NEW)
  function readNotifs(){ try { return JSON.parse(localStorage.getItem(NOTIFS_KEY)) || []; } catch(e){ return []; } }
  function writeNotifs(list){ localStorage.setItem(NOTIFS_KEY, JSON.stringify(list)); }
  function addNotif(entry){
    const list = readNotifs();
    list.unshift(entry); // newest first
    writeNotifs(list);
  }

  function formatPrice(n){ return `₵ ${Number(n).toFixed(2)}`; }
  function uid(){ return Math.random().toString(36).slice(2,9)+Date.now().toString(36).slice(-4); }

  // UI refs
  const q = document.getElementById('q');
  const listEl = document.getElementById('list');
  const overlay = document.getElementById('overlay');
  const mImg = document.getElementById('mImg');
  const mName = document.getElementById('mName');
  const mUnit = document.getElementById('mUnit');
  const mStock = document.getElementById('mStock');
  const mQty = document.getElementById('mQty');
  const mTotal = document.getElementById('mTotal');
  const alertBox = document.getElementById('alert');
  const alertMsg = document.getElementById('alertMsg');
  const btnComplete = document.getElementById('btnComplete');
  const btnCancel = document.getElementById('btnCancel');

  const toast = document.getElementById('toast');
  const toastMsg = document.getElementById('toastMsg');

  // List render
  function stockBadge(q){
    if(q <= 4)  return ['b-red',   `${q} in stock`];
    if(q <= 19) return ['b-yellow',`${q} in stock`];
    return ['b-green', `${q} in stock`];
  }

  let cache = []; // owner filtered
  function load(){
    const all = readProducts().filter(p => p.ownerId === current.id);
    cache = all.sort((a,b) => a.name.localeCompare(b.name));
    draw();
  }

  function draw(){
    const term=(q.value||'').toLowerCase().trim();
    const items = term? cache.filter(p => p.name.toLowerCase().includes(term)) : cache;

    listEl.innerHTML='';
    items.forEach(p=>{
      const [cls,btxt] = stockBadge(Number(p.qty)||0);
      const row = document.createElement('button');
      row.type='button';
      row.className='row';
      row.innerHTML = `
        <img class="thumb" src="${p.image||''}" alt="" onerror="this.style.display='none'">
        <div><div class="name">${p.name}</div><div class="price">${formatPrice(p.price)}</div></div>
        <span class="badge ${cls}">${btxt}</span>
      `;
      row.addEventListener('click', ()=> openModal(p.id));
      listEl.appendChild(row);
    });
  }

  q.addEventListener('input', draw);

  // Modal logic
  let editing = null; // product in modal

  function openModal(id){
    const p = readProducts().find(x => x.id === id && x.ownerId === current.id);
    if(!p) return;
    editing = p;

    mImg.src = p.image || '';
    mImg.style.display = p.image ? 'block' : 'none';
    mName.textContent = p.name;
    mUnit.textContent = `${formatPrice(p.price)} each`;
    const [cls, btxt] = stockBadge(Number(p.qty)||0);
    // map list badge -> modal pill color (NEW)
    const pillClass = cls === 'b-red' ? 'pill-red' : cls === 'b-yellow' ? 'pill-yellow' : 'pill-green';
    mStock.className = `pill ${pillClass}`;
    mStock.textContent = btxt;

    // always default to 1 when there’s stock (NEW)
    mQty.value = Math.max(1, Math.min(1, Number(p.qty)||0) || 1);
    computeTotal();
    showAlert(false, '');
    overlay.classList.add('show');
    overlay.setAttribute('aria-hidden','false');
    mQty.focus();
  }

  function showAlert(show, msg){
    if(show){ alertMsg.textContent = msg; alertBox.classList.add('show'); }
    else { alertBox.classList.remove('show'); }
  }

  function closeModal(){ overlay.classList.remove('show'); overlay.setAttribute('aria-hidden','true'); editing = null; }

  function computeTotal(){
    const qty = Number(mQty.value)||0;
    const total = qty * (Number(editing?.price)||0);
    mTotal.textContent = formatPrice(total);
    if(editing){
      const available = Number(editing.qty)||0;
      if(qty<1){ showAlert(true,'Enter at least 1.'); btnComplete.disabled = true; return; }
      if(qty>available){
        showAlert(true, `Only ${available} of this item ${available===1?'is':'are'} available`);
        btnComplete.disabled = true;
        return;
      }
    }
    showAlert(false,''); btnComplete.disabled = false;
  }

  mQty.addEventListener('input', computeTotal);

  btnCancel.addEventListener('click', closeModal);
  overlay.addEventListener('click', (e)=>{ if(e.target === overlay) closeModal(); });

  // Close with Esc (NEW)
  document.addEventListener('keydown', (e)=>{
    if(e.key === 'Escape' && overlay.classList.contains('show')) closeModal();
  });

  // Basic focus trap in modal (NEW)
  overlay.addEventListener('keydown', (e)=>{
    if(e.key !== 'Tab' || !overlay.classList.contains('show')) return;
    const focusables = overlay.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
    if(!focusables.length) return;
    const first = focusables[0], last = focusables[focusables.length-1];
    if(e.shiftKey && document.activeElement === first){ e.preventDefault(); last.focus(); }
    else if(!e.shiftKey && document.activeElement === last){ e.preventDefault(); first.focus(); }
  });

  // Complete sale -> save product, sale, and notifications (NEW)
  btnComplete.addEventListener('click', ()=>{
    if(!editing) return;

    const qty = Math.floor(Number(mQty.value)||0);
    const available = Number(editing.qty)||0;
    if(qty < 1 || qty > available){ computeTotal(); return; }

    // Update product
    const products = readProducts();
    const idx = products.findIndex(x => x.id === editing.id && x.ownerId === current.id);
    if(idx === -1) return;

    const now = new Date();
    const nowISO = now.toISOString();
    const nowMs  = now.getTime();

    products[idx].qty = available - qty;
    products[idx].updatedAt   = nowISO;
    products[idx].updatedAtMs = nowMs;
    products[idx].lastSaleQty = qty;
    products[idx].lastSaleAt  = nowISO;

    writeProducts(products); // product saved

    // Save sale record
    const unit = Number(editing.price)||0;
    const sale = {
      id: uid(),
      ownerId: current.id,
      productId: editing.id,
      qty,
      unitPrice: unit,
      total: qty * unit,
      product: { name: editing.name, image: editing.image || null },
      createdAt: nowISO,
      createdAtMs: nowMs
    };
    const sales = readSales();
    sales.push(sale);
    writeSales(sales); // sale saved

    // Notifications
    addNotif({
      id: uid(),
      ownerId: current.id,
      type: 'sale',
      productId: editing.id,
      name: editing.name,
      qty,
      unitPrice: unit,
      total: qty * unit,
      createdAtMs: nowMs
    });

    const newQty = products[idx].qty || 0;
    if(newQty === 0){
      addNotif({
        id: uid(),
        ownerId: current.id,
        type: 'out_of_stock',
        productId: editing.id,
        name: editing.name,
        createdAtMs: nowMs
      });
    } else if(newQty <= 4){
      addNotif({
        id: uid(),
        ownerId: current.id,
        type: 'low_stock',
        productId: editing.id,
        name: editing.name,
        qty: newQty,
        createdAtMs: nowMs
      });
    }

    // UI success
    closeModal();
    toastMsg.textContent = `${editing.name} (${qty}) is sold`;
    toast.classList.add('show');
    setTimeout(()=> toast.classList.remove('show'), 2300);

    // Refresh list to reflect new stock
    load();
    window.scrollTo({ top: 0, behavior: 'smooth' });
  });

  // init
  load();
</script>
<script>
  // inject the sidebar
  fetch('sidebar.html')
    .then(r => r.text())
    .then(html => {
      document.getElementById('sidebar-mount').outerHTML = html;
    });
</script>
</body>
</html>
